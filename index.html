<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª—ä—Ç –Ω–µ –ª—ä–∂–µ: –ñ–∏–≤–∞—Ç–∞ –∫–Ω–∏–≥–∞ [v10/10 - –†–∞–±–æ—Ç–µ—â–∞]</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS-—ä—Ç –µ —Å—ä—â–∏—è—Ç –∫–∞—Ç–æ –≤ –ø—Ä–µ–¥–∏—à–Ω–∏—è –æ—Ç–≥–æ–≤–æ—Ä, —Ç—ä–π –∫–∞—Ç–æ –µ –∫–æ—Ä–µ–∫—Ç–µ–Ω. */
        /* –ó–∞ –¥–∞ –Ω–µ –µ –ø—Ä–µ–∫–∞–ª–µ–Ω–æ –¥—ä–ª—ä–≥ –æ—Ç–≥–æ–≤–æ—Ä—ä—Ç, —Ç—É–∫ —â–µ —Å–ª–æ–∂–∞ —Å–∞–º–æ –æ—Å–Ω–æ–≤–Ω–∏—Ç–µ —Å—Ç–∏–ª–æ–≤–µ. */
        :root {
            --font-serif: 'Lora', serif;
            --font-sans: 'Inter', sans-serif;
            --bg-color: #FFFFFF;
            --text-color: #1a1a1a;
            --accent-color: #007AFF;
            --subtle-bg: #f5f5f7;
            --subtle-border: #e5e5e5;
            --highlight-color: rgba(0, 122, 255, 0.2);
        }
        .dark-mode { --bg-color: #121212; --text-color: #e2e2e2; --accent-color: #0A84FF; --subtle-bg: #1c1c1e; --subtle-border: #3a3a3c; --highlight-color: rgba(10, 132, 255, 0.3); }
        .sepia-mode { --bg-color: #fbf0d9; --text-color: #5b4636; --accent-color: #8D6E63; --subtle-bg: #ede0c8; --subtle-border: #dcd0b8; --highlight-color: rgba(141, 110, 99, 0.3); }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-serif); background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s ease, color 0.3s ease; -webkit-font-smoothing: antialiased; }
        .progress-bar { position: fixed; top: 0; left: 0; height: 4px; background-color: var(--accent-color); width: 0%; z-index: 1000; transition: width 0.1s linear; }
        .container { max-width: 800px; margin: 0 auto; padding: 2rem 1.5rem; }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1.5rem; border-bottom: 1px solid var(--subtle-border); margin-bottom: 2rem; }
        .header-left, .header-right { display: flex; align-items: center; gap: 1rem; }
        .app-header h1 { font-family: var(--font-sans); font-size: 1.2rem; font-weight: 600; cursor: pointer; }
        .icon-button { background: none; border: none; cursor: pointer; color: var(--text-color); padding: 0.5rem; display: flex; align-items: center; justify-content: center; }
        .icon-button svg { width: 24px; height: 24px; pointer-events: none; }
        .settings-panel { position: fixed; top: 0; right: -320px; width: 300px; height: 100%; background-color: var(--subtle-bg); border-left: 1px solid var(--subtle-border); padding: 1.5rem; transition: right 0.3s ease-in-out; z-index: 999; }
        .settings-panel.open { right: 0; }
        .settings-panel h3, .nav-panel h3 { font-family: var(--font-sans); margin-bottom: 1.5rem; }
        .setting-group { margin-bottom: 2rem; }
        .setting-group label { font-family: var(--font-sans); font-size: 0.9rem; display: block; margin-bottom: 0.8rem; font-weight: 600;}
        .theme-controls, .font-size-controls { display: flex; gap: 0.8rem; }
        .theme-dot { width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--subtle-border); cursor: pointer; }
        .theme-dot.active { border-color: var(--accent-color); }
        .theme-dot#light { background-color: #FFFFFF; }
        .theme-dot#dark { background-color: #1c1c1e; }
        .theme-dot#sepia { background-color: #fbf0d9; }
        .font-size-controls button { background-color: var(--bg-color); border: 1px solid var(--subtle-border); color: var(--text-color); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-family: var(--font-sans); font-weight: bold; }
        .nav-panel { position: fixed; top: 0; left: -320px; width: 300px; height: 100%; background-color: var(--subtle-bg); border-right: 1px solid var(--subtle-border); padding: 1.5rem; transition: left 0.3s ease-in-out; z-index: 999; overflow-y: auto; }
        .nav-panel.open { left: 0; }
        .nav-list { list-style: none; }
        .nav-list .part-title { font-family: var(--font-sans); font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--accent-color); }
        .nav-list .chapter-link { display: block; padding: 0.5rem 0; color: var(--text-color); text-decoration: none; font-size: 0.9rem; }
        .nav-list .chapter-link:hover { color: var(--accent-color); }
        .content-view { line-height: 1.8; font-size: 18px; }
        .content-view h2 { font-family: var(--font-sans); font-size: 2em; margin: 2em 0 1em 0; line-height: 1.2; }
        .content-view h3 { font-family: var(--font-sans); font-size: 1.5em; margin: 1.5em 0 0.8em 0; line-height: 1.3; }
        .content-view p { margin-bottom: 1.2em; }
        .content-view blockquote { margin: 2em 0; padding-left: 1.5em; border-left: 2px solid var(--accent-color); font-style: italic; }
        .content-view blockquote cite { display: block; margin-top: 0.5em; font-style: normal; }
        .content-view ::selection { background-color: var(--highlight-color); }
        .content-view .highlight { background-color: var(--highlight-color); cursor: pointer; }
        .interactive-exercise { background-color: var(--subtle-bg); border: 1px solid var(--subtle-border); border-radius: 12px; padding: 1.5rem; margin: 2rem 0; }
        .interactive-exercise .exercise-title { font-family: var(--font-sans); font-weight: 600; font-size: 1.2em; margin-bottom: 0.5rem; }
        .interactive-exercise .instructions { font-size: 0.9em; opacity: 0.8; margin-bottom: 1.5rem; }
        .interactive-exercise textarea { width: 100%; min-height: 100px; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--subtle-border); background-color: var(--bg-color); color: var(--text-color); font-family: var(--font-serif); font-size: 1em; }
        .dashboard-view { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .dashboard-card { background-color: var(--subtle-bg); border-radius: 12px; padding: 1.5rem; }
        .dashboard-card h3 { font-family: var(--font-sans); font-size: 1.1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--subtle-border); padding-bottom: 0.5rem;}
        #continue-reading-btn { display: block; width: 100%; padding: 1rem; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; font-family: var(--font-sans); font-size: 1rem; font-weight: 600; cursor: pointer; }
        #my-insights-list, #my-achievements-list { list-style: none; font-size: 0.9rem; max-height: 200px; overflow-y: auto; }
        #my-insights-list li { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed var(--subtle-border); cursor: pointer; }
        #my-insights-list li:last-child { border-bottom: none; }
        #my-achievements-list li { display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.5rem; }
        #my-achievements-list li.unlocked { opacity: 1; }
        #my-achievements-list li.locked { opacity: 0.4; }
        #highlighter-menu { position: absolute; background-color: var(--subtle-bg); border: 1px solid var(--subtle-border); border-radius: 8px; padding: 0.5rem; display: none; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #highlighter-menu button { background: none; border: none; padding: 0.5rem; cursor: pointer; color: var(--text-color); }
        #achievement-toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: #2c2c2e; color: white; padding: 1rem 1.5rem; border-radius: 12px; font-family: var(--font-sans); text-align: center; transition: bottom 0.5s ease-in-out; z-index: 1001; }
        #achievement-toast.show { bottom: 2rem; }
    </style>
</head>
<body>

    <div class="progress-bar" id="progress-bar"></div>

    <div class="container">
        <header class="app-header">
            <div class="header-left">
                <button class="icon-button" id="nav-toggle" title="–°—ä–¥—ä—Ä–∂–∞–Ω–∏–µ">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4H21V6H3V4ZM3 11H21V13H3V11ZM3 18H21V20H3V18Z"></path></svg>
                </button>
                <h1 id="app-title">–ü—Ä–æ—Ñ–∏–ª—ä—Ç –Ω–µ –ª—ä–∂–µ</h1>
            </div>
            <div class="header-right">
                <button class="icon-button" id="settings-toggle" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9.98438 1.99219L11.9844 5.35938L15.9844 5.79688L13.2188 8.78125L13.9844 12.8906L9.98438 10.7344L5.98438 12.8906L6.75 8.78125L3.98438 5.79688L7.98438 5.35938L9.98438 1.99219ZM9.98438 14C10.8129 14 11.4844 13.3284 11.4844 12.5C11.4844 11.6716 10.8129 11 9.98438 11C9.15594 11 8.48438 11.6716 8.48438 12.5C8.48438 13.3284 9.15594 14 9.98438 14ZM9.10938 16.4844C7.45312 16.8594 6.125 18.0938 5.65625 19.7031L6.54688 20.0781C6.92188 18.7969 7.85938 17.8594 8.98438 17.5156L9.10938 16.4844ZM10.8594 16.4844L10.9844 17.5156C12.1094 17.8594 13.0469 18.7969 13.4219 20.0781L14.3125 19.7031C13.8438 18.0938 12.5156 16.8594 10.8594 16.4844Z"></path></svg>
                </button>
            </div>
        </header>
        <main id="main-content"></main>
    </div>
    
    <div class="nav-panel" id="nav-panel">
        <h3>–°—ä–¥—ä—Ä–∂–∞–Ω–∏–µ</h3>
        <ul class="nav-list" id="nav-list-container"></ul>
    </div>
    <div class="settings-panel" id="settings-panel">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <div class="setting-group">
            <label>–¶–≤–µ—Ç–æ–≤–∞ —Ç–µ–º–∞</label>
            <div class="theme-controls">
                <button id="light" class="theme-dot" title="–°–≤–µ—Ç–ª–∞"></button>
                <button id="dark" class="theme-dot" title="–¢—ä–º–Ω–∞"></button>
                <button id="sepia" class="theme-dot" title="–°–µ–ø–∏—è"></button>
            </div>
        </div>
        <div class="setting-group">
            <label>–†–∞–∑–º–µ—Ä –Ω–∞ —à—Ä–∏—Ñ—Ç–∞</label>
            <div class="font-size-controls">
                <button id="font-decrease" title="–ù–∞–º–∞–ª–∏ —à—Ä–∏—Ñ—Ç–∞">A-</button>
                <button id="font-increase" title="–£–≤–µ–ª–∏—á–∏ —à—Ä–∏—Ñ—Ç–∞">A+</button>
            </div>
        </div>
    </div>
    
    <div id="highlighter-menu">
        <button id="highlight-btn" title="–ü–æ–¥—á–µ—Ä—Ç–∞–π">üé®</button>
        <button id="share-btn" title="–°–ø–æ–¥–µ–ª–∏ –∫–∞—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞">üñºÔ∏è</button>
    </div>

    <div id="achievement-toast">
        <strong id="achievement-title"></strong>
        <p id="achievement-desc"></p>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const bookData = {
            "bookMeta": { "title": "–ü—Ä–æ—Ñ–∏–ª—ä—Ç –Ω–µ –ª—ä–∂–µ", "author": "–í–∞—à–∏—è—Ç –µ–∫–∏–ø" },
            "parts": [
                {
                    "partNumber": 5, "partTitle": "–û–ì–õ–ï–î–ê–õ–û–¢–û",
                    "chapters": [
                        {
                            "chapterId": "ch13", "chapterTitle": "–í–∞—à–∏—è—Ç –¥–∏–≥–∏—Ç–∞–ª–µ–Ω –æ–¥–∏—Ç",
                            "epigraph": { "text": "–ù–µ–æ—Å—ä–∑–Ω–∞—Ç–∏—è—Ç –∂–∏–≤–æ—Ç –Ω–µ —Å–∏ —Å—Ç—Ä—É–≤–∞ –¥–∞ —Å–µ –∂–∏–≤–µ–µ.", "source": "–°–æ–∫—Ä–∞—Ç" },
                            "contentBlocks": [
                                { "type": "paragraph", "content": "–î–æ—Ç—É–∫ —Å–µ —É–ø—Ä–∞–∂–Ω—è–≤–∞—Ö–º–µ –¥–∞ –±—ä–¥–µ–º –¥–∏–≥–∏—Ç–∞–ª–Ω–∏ –ø—Å–∏—Ö–æ–ª–æ–∑–∏, –Ω–∞–±–ª—é–¥–∞–≤–∞–π–∫–∏ —Å–≤–µ—Ç–∞ –æ–∫–æ–ª–æ –Ω–∞—Å. –ê–Ω–∞–ª–∏–∑–∏—Ä–∞—Ö–º–µ –ø—Ä–æ—Ñ–∏–ª–∏—Ç–µ –Ω–∞ –ø—Ä–∏—è—Ç–µ–ª–∏, –ø–æ–∑–Ω–∞—Ç–∏ –∏ –∏–Ω—Ñ–ª—É–µ–Ω—Å—ä—Ä–∏. –ù–∞—É—á–∏—Ö–º–µ —Å–µ –¥–∞ —Ä–∞–∑—á–∏—Ç–∞–º–µ —Å–∫—Ä–∏—Ç–∏—Ç–µ —Å–∏–≥–Ω–∞–ª–∏, –¥–∞ —Ä–∞–∑–ø–æ–∑–Ω–∞–≤–∞–º–µ –∞—Ä—Ö–µ—Ç–∏–ø–∏ –∏ –¥–∞ —Ä–∞–∑–±–∏—Ä–∞–º–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ç–µ –¥–≤–∏–≥–∞—Ç–µ–ª–∏ –∑–∞–¥ –≤—Å–µ–∫–∏ –ª–∞–π–∫ –∏ –∫–æ–º–µ–Ω—Ç–∞—Ä. –ò—Å—Ç–∏–Ω—Å–∫–∞—Ç–∞ —Ä–∞–±–æ—Ç–∞ –∑–∞–ø–æ—á–≤–∞ —Å–µ–≥–∞." },
                                { "type": "paragraph", "content": "–¢–æ–∑–∏ –ø—Ä–æ—Ü–µ—Å –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –Ω–µ–∫–æ–º—Ñ–æ—Ä—Ç–µ–Ω. –ú–æ–∂–µ –¥–∞ —Ä–∞–∑–∫—Ä–∏–µ –Ω–µ—â–∞ –∑–∞ –Ω–∞—Å, –∫–æ–∏—Ç–æ –Ω–µ —Å–º–µ –æ—Å—ä–∑–Ω–∞–≤–∞–ª–∏ –∏–ª–∏ –∫–æ–∏—Ç–æ —Å–º–µ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–ª–∏ –¥–∞ –∏–≥–Ω–æ—Ä–∏—Ä–∞–º–µ. –ù–æ —Ç–æ–π –µ –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º. –û—Ç–¥–µ–ª–µ—Ç–µ —Å–∏ –µ–¥–∏–Ω —á–∞—Å –∏ –±—ä–¥–µ—Ç–µ –±—Ä—É—Ç–∞–ª–Ω–æ —á–µ—Å—Ç–Ω–∏ —Å—ä—Å —Å–µ–±–µ —Å–∏." },
                                { "type": "heading", "level": 3, "content": "–°—Ç—ä–ø–∫–∞ 1: –î–µ—Ñ–∏–Ω–∏—Ä–∞–Ω–µ –Ω–∞ –º–æ—Ç–∏–≤–∞—Ü–∏—è—Ç–∞" },
                                { "type": "paragraph", "content": "–ü—Ä–µ–¥–∏ –¥–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä–∞—Ç–µ *–∫–∞–∫–≤–æ* –ø—É–±–ª–∏–∫—É–≤–∞—Ç–µ, —Ç—Ä—è–±–≤–∞ –¥–∞ —Ä–∞–∑–±–µ—Ä–µ—Ç–µ *–∑–∞—â–æ* –≥–æ –ø—Ä–∞–≤–∏—Ç–µ." },
                                { "type": "interactiveExercise", "exerciseId": "ex13_1", "title": "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: –†–∞–∑–∫–æ–¥–∏—Ä–∞–Ω–µ –Ω–∞ –º–æ—Ç–∏–≤–∞—Ü–∏—è—Ç–∞", "instructions": "–ü—Ä–µ–≥–ª–µ–¥–∞–π—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ç–µ —Å–∏ 10 –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏ –∑–∞–ø–∏—à–µ—Ç–µ –∫–∞–∫–≤–æ —Å—Ç–µ —Å–µ –Ω–∞–¥—è–≤–∞–ª–∏ –¥–∞ –ø–æ—Å—Ç–∏–≥–Ω–µ—Ç–µ —Å –≤—Å—è–∫–∞. –û—Ç–≥–æ–≤–æ—Ä–∏—Ç–µ –≤–∏ —Å–µ –∑–∞–ø–∞–∑–≤–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.", "fields": [{ "fieldId": "motivation_text", "fieldType": "textarea", "placeholder": "–ú–æ–∏—Ç–µ –º–∏—Å–ª–∏ –∏ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –±—è—Ö–∞..." }] }
                            ]
                        },
                        {
                            "chapterId": "ch14", "chapterTitle": "–ù–µ—Å—ä–∑–Ω–∞—Ç–µ–ª–Ω–∏—Ç–µ –º–æ–¥–µ–ª–∏",
                            "epigraph": { "text": "–î–æ–∫–∞—Ç–æ –Ω–µ –Ω–∞–ø—Ä–∞–≤–∏—à –Ω–µ—Å—ä–∑–Ω–∞—Ç–µ–ª–Ω–æ—Ç–æ —Å—ä–∑–Ω–∞—Ç–µ–ª–Ω–æ, —Ç–æ —â–µ —É–ø—Ä–∞–≤–ª—è–≤–∞ –∂–∏–≤–æ—Ç–∞ —Ç–∏ –∏ —Ç–∏ —â–µ –≥–æ –Ω–∞—Ä–∏—á–∞—à —Å—ä–¥–±–∞.", "source": "–ö–∞—Ä–ª –Æ–Ω–≥" },
                            "contentBlocks": [
                                { "type": "paragraph", "content": "–î–∏–≥–∏—Ç–∞–ª–Ω–∏—è—Ç –æ–¥–∏—Ç –≤–∏ –¥–∞–¥–µ –º–æ–º–µ–Ω—Ç–Ω–∞ —Å–Ω–∏–º–∫–∞. –ù–æ –∏—Å—Ç–∏–Ω—Å–∫–∞—Ç–∞ —Å–∏–ª–∞ —Å–µ –∫—Ä–∏–µ –≤ —Ä–∞–∑–ø–æ–∑–Ω–∞–≤–∞–Ω–µ—Ç–æ –Ω–∞ *–º–æ–¥–µ–ª–∏—Ç–µ*, –∫–æ–∏—Ç–æ —Å–µ –ø–æ–≤—Ç–∞—Ä—è—Ç –≤—ä–≤ –≤—Ä–µ–º–µ—Ç–æ ‚Äì —Ü–∏–∫–ª–∏—Ç–µ, –≤ –∫–æ–∏—Ç–æ –ø–æ–ø–∞–¥–∞–º–µ –æ—Ç–Ω–æ–≤–æ –∏ –æ—Ç–Ω–æ–≤–æ, —á–µ—Å—Ç–æ –±–µ–∑ –¥–æ—Ä–∏ –¥–∞ –≥–æ –æ—Å—ä–∑–Ω–∞–≤–∞–º–µ." }
                            ]
                        }
                    ]
                }
            ]
        };
        
        const App = {
            state: {
                theme: 'light', fontSize: 18, currentView: 'dashboard', currentChapterId: 'ch13',
                highlights: [], exerciseAnswers: {}, unlockedAchievements: []
            },
            
            init() {
                this.cacheDOM();
                this.loadState();
                this.renderNav();
                this.bindEvents();
                this.renderView(this.state.currentView, this.state.currentChapterId);
            },
            
            cacheDOM() {
                this.dom = {
                    body: document.body,
                    mainContent: document.getElementById('main-content'),
                    navPanel: document.getElementById('nav-panel'),
                    settingsPanel: document.getElementById('settings-panel'),
                    navListContainer: document.getElementById('nav-list-container'),
                    appTitle: document.getElementById('app-title'),
                    progressBar: document.getElementById('progress-bar'),
                    highlighterMenu: document.getElementById('highlighter-menu')
                };
            },
            
            saveState() { localStorage.setItem('bookAppState', JSON.stringify(this.state)); },
            loadState() {
                const savedState = JSON.parse(localStorage.getItem('bookAppState'));
                if (savedState) this.state = { ...this.state, ...savedState };
                this.applySettings();
            },

            applySettings() {
                // Theme
                this.dom.body.classList.remove('dark-mode', 'sepia-mode');
                if (this.state.theme !== 'light') this.dom.body.classList.add(`${this.state.theme}-mode`);
                document.querySelectorAll('.theme-dot').forEach(btn => {
                    btn.classList.toggle('active', btn.id === this.state.theme);
                });
                // Font size
                this.dom.mainContent.style.fontSize = `${this.state.fontSize}px`;
            },
            
            bindEvents() {
                document.getElementById('nav-toggle').addEventListener('click', () => this.dom.navPanel.classList.toggle('open'));
                document.getElementById('settings-toggle').addEventListener('click', () => this.dom.settingsPanel.classList.toggle('open'));
                this.dom.appTitle.addEventListener('click', () => this.renderView('dashboard'));
                
                document.querySelectorAll('.theme-dot').forEach(btn => btn.addEventListener('click', e => {
                    this.state.theme = e.target.id;
                    this.applySettings();
                    this.saveState();
                }));
                
                document.getElementById('font-increase').addEventListener('click', () => this.updateFontSize(1));
                document.getElementById('font-decrease').addEventListener('click', () => this.updateFontSize(-1));

                this.dom.navListContainer.addEventListener('click', e => {
                    if (e.target.matches('.chapter-link')) {
                        e.preventDefault();
                        this.renderView('chapter', e.target.dataset.chapterId);
                        this.dom.navPanel.classList.remove('open');
                    }
                });
                
                this.dom.mainContent.addEventListener('click', e => {
                    if (e.target.matches('#continue-reading-btn')) this.renderView('chapter', this.state.currentChapterId);
                });

                this.dom.mainContent.addEventListener('input', e => {
                    if (e.target.matches('textarea[data-exercise-id]')) {
                        const id = e.target.dataset.exerciseId;
                        this.state.exerciseAnswers[id] = e.target.value;
                        this.checkAchievements();
                        this.saveState();
                    }
                });

                window.addEventListener('scroll', () => this.updateProgress());
                
                // Highlighter events
                this.dom.mainContent.addEventListener('mouseup', e => this.handleTextSelection(e));
                document.addEventListener('mousedown', e => {
                    if (!this.dom.highlighterMenu.contains(e.target)) this.dom.highlighterMenu.style.display = 'none';
                });
                document.getElementById('highlight-btn').addEventListener('click', () => this.addHighlight());
            },

            updateFontSize(change) {
                const newSize = this.state.fontSize + change;
                if (newSize >= 14 && newSize <= 28) {
                    this.state.fontSize = newSize;
                    this.applySettings();
                    this.saveState();
                }
            },
            
            renderView(view, id = null) {
                this.state.currentView = view;
                if (id) this.state.currentChapterId = id;
                window.scrollTo(0, 0);

                if (view === 'dashboard') {
                    this.dom.mainContent.innerHTML = this.getDashboardHTML();
                    this.dom.appTitle.textContent = "–¢–∞–±–ª–æ –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ";
                } else {
                    this.dom.mainContent.innerHTML = this.getChapterHTML(id);
                    this.dom.appTitle.textContent = "–ü—Ä–æ—Ñ–∏–ª—ä—Ç –Ω–µ –ª—ä–∂–µ";
                    this.applyHighlights(id);
                }
                this.saveState();
            },

            getChapterHTML(chapterId) {
                const part = bookData.parts.find(p => p.chapters.some(c => c.chapterId === chapterId));
                if (!part) return `<p>–ì–ª–∞–≤–∞—Ç–∞ –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞.</p>`;
                const chapter = part.chapters.find(c => c.chapterId === chapterId);

                let html = `<div class="content-view" id="content-view-area"><h2>${chapter.chapterTitle}</h2>`;
                if(chapter.epigraph) html += `<blockquote class="epigraph"><p>${chapter.epigraph.text}</p><cite>‚Äì ${chapter.epigraph.source}</cite></blockquote>`;
                
                chapter.contentBlocks.forEach(block => {
                    switch(block.type) {
                        case 'paragraph': html += `<p>${block.content.replace(/\*(.*?)\*/g, '<em>$1</em>')}</p>`; break;
                        case 'heading': html += `<h${block.level}>${block.content}</h${block.level}>`; break;
                        case 'interactiveExercise':
                            html += `
                            <div class="interactive-exercise">
                                <h4 class="exercise-title">${block.title}</h4>
                                <p class="instructions">${block.instructions}</p>
                                <textarea data-exercise-id="${block.exerciseId}" placeholder="${block.fields[0].placeholder}">${this.state.exerciseAnswers[block.exerciseId] || ''}</textarea>
                            </div>`;
                            break;
                    }
                });
                return html + '</div>';
            },

            getDashboardHTML() {
                const continueChapterTitle = bookData.parts[0].chapters.find(c => c.chapterId === this.state.currentChapterId)?.chapterTitle || '–ù–∞—á–∞–ª–æ';
                const highlightsHtml = this.state.highlights.length > 0 ?
                    this.state.highlights.map(h => `<li data-chapter-id="${h.chapterId}">"${h.text}"</li>`).join('') :
                    `<li>–í—Å–µ –æ—â–µ –Ω—è–º–∞—Ç–µ –ø–æ–¥—á–µ—Ä—Ç–∞–Ω–∏ –ø—Ä–æ–∑—Ä–µ–Ω–∏—è.</li>`;

                const achievements = [ {id: 'ach_01', title: '–ü—ä—Ä–≤–∞ —Å—Ç—ä–ø–∫–∞' }];
                const achievementsHtml = achievements.map(a => 
                    `<li class="${this.state.unlockedAchievements.includes(a.id) ? 'unlocked' : 'locked'}">
                        <span>üèÜ</span> ${a.title}
                    </li>`
                ).join('');

                return `
                <div class="dashboard-view">
                    <div class="dashboard-card" style="grid-column: 1 / -1;">
                        <button id="continue-reading-btn">–ü—Ä–æ–¥—ä–ª–∂–∏ —Å —á–µ—Ç–µ–Ω–µ—Ç–æ (${continueChapterTitle})</button>
                    </div>
                    <div class="dashboard-card"><h3>–ú–æ–∏—Ç–µ –ø—Ä–æ–∑—Ä–µ–Ω–∏—è</h3><ul id="my-insights-list">${highlightsHtml}</ul></div>
                    <div class="dashboard-card"><h3>–ü–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3><ul id="my-achievements-list">${achievementsHtml}</ul></div>
                </div>`;
            },

            renderNav() {
                let navHtml = '';
                bookData.parts.forEach(part => {
                    navHtml += `<li class="part-title">${part.partTitle}</li>`;
                    part.chapters.forEach(chapter => {
                        navHtml += `<li><a href="#" class="chapter-link" data-chapter-id="${chapter.chapterId}">${chapter.chapterTitle}</a></li>`;
                    });
                });
                this.dom.navListContainer.innerHTML = navHtml;
            },
            
            updateProgress() {
                if (this.state.currentView !== 'chapter') {
                    this.dom.progressBar.style.width = '0%';
                    return;
                }
                const contentArea = document.getElementById('content-view-area');
                if (!contentArea) return;
                const scrollableHeight = contentArea.scrollHeight - window.innerHeight;
                const scrollTop = window.scrollY;
                const progress = scrollableHeight > 0 ? (scrollTop / scrollableHeight) * 100 : 0;
                this.dom.progressBar.style.width = `${Math.min(progress, 100)}%`;
            },
            
            handleTextSelection(e) {
                const selection = window.getSelection();
                if (selection.toString().length > 5) {
                    this.currentSelection = selection.getRangeAt(0);
                    const rect = this.currentSelection.getBoundingClientRect();
                    this.dom.highlighterMenu.style.left = `${e.clientX}px`;
                    this.dom.highlighterMenu.style.top = `${e.clientY - 50}px`;
                    this.dom.highlighterMenu.style.display = 'block';
                } else {
                    this.dom.highlighterMenu.style.display = 'none';
                }
            },

            addHighlight() {
                if (!this.currentSelection) return;
                const selectionText = this.currentSelection.toString().trim();
                const highlightId = `hl_${Date.now()}`;
                
                // –ó–∞–ø–∞–∑–≤–∞–º–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞
                this.state.highlights.push({
                    id: highlightId,
                    text: selectionText,
                    chapterId: this.state.currentChapterId
                });
                this.saveState();

                // –û–±–≤–∏–≤–∞–º–µ –≤–∏–∑—É–∞–ª–Ω–æ
                const span = document.createElement('span');
                span.className = 'highlight';
                span.id = highlightId;
                this.currentSelection.surroundContents(span);
                
                window.getSelection().removeAllRanges();
                this.dom.highlighterMenu.style.display = 'none';
            },

            applyHighlights(chapterId) {
                this.state.highlights
                    .filter(h => h.chapterId === chapterId)
                    .forEach(h => {
                        const content = this.dom.mainContent.innerHTML;
                        const highlightedContent = content.replace(h.text, `<span class="highlight" id="${h.id}">${h.text}</span>`);
                        if (content !== highlightedContent) {
                            this.dom.mainContent.innerHTML = highlightedContent;
                        }
                    });
            },

            checkAchievements() {
                if (Object.keys(this.state.exerciseAnswers).length > 0 && !this.state.unlockedAchievements.includes('ach_01')) {
                    this.state.unlockedAchievements.push('ach_01');
                    this.showAchievementToast('–ü—ä—Ä–≤–∞ —Å—Ç—ä–ø–∫–∞!', '–ü–æ–ø—ä–ª–Ω–∏—Ö—Ç–µ –ø—ä—Ä–≤–æ—Ç–æ —Å–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ.');
                }
            },
            
            showAchievementToast(title, desc) {
                const toast = document.getElementById('achievement-toast');
                document.getElementById('achievement-title').textContent = title;
                document.getElementById('achievement-desc').textContent = desc;
                toast.classList.add('show');
                setTimeout(() => { toast.classList.remove('show'); }, 4000);
            }
        };

        App.init();
    });
    </script>
</body>
</html>
